<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE sect1
[
  <!ENTITY % entities SYSTEM "generic-entities.ent">
    %entities;
]>

<sect1 xml:id="sec-warewulf-deploy-nodes" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.1"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink">
 <title>Deploying compute nodes with &warewulf;</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker></dm:bugtracker>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

<remark>Control node vs control server vs controller host vs warewulf server??
 I've seen all these terms used... which one will we use?</remark>

 <para>
  &warewulf; is a node deployment system for &hpc; clusters. The compute nodes are booted
  over the network using PXE. &warewulf; configures DHCP and TFTP on the &warewulf; server
  (or control node), and configures the compute nodes using <emphasis>node profiles</emphasis>
  and <emphasis>&warewulf; overlays</emphasis>.
 </para>
 <para>
  <emphasis>Node profiles</emphasis> group shared node configurations together, such as
  the container or kernel, overlays, and IPMI settings. New nodes automatically use the
  <literal>default</literal> node profile. You can also create additional node profiles,
  for example, if two groups of nodes require different containers.
 </para>
 <para>
  <emphasis>&warewulf; overlays</emphasis> are compiled for each individual compute node.
  System overlays (or <literal>wwinit</literal> overlays) are applied during boot and are
  used for configuration that is node-specific, such as networking and services. Runtime
  overlays are applied periodically while the node is running, and are used for configuration
  that changes, such as users and groups.
 </para>

 <itemizedlist>
  <title>Requirements</title>
  <listitem>
   <para>
    The &warewulf; control node has a static IP address.
   </para>
  </listitem>
  <listitem>
   <para>
    The compute nodes are set to PXE boot.
   </para>
  </listitem>
 </itemizedlist>

 <procedure xml:id="pro-warewulf-deploy-nodes">
  <title>Deploying compute nodes with &warewulf;</title>
  <step>
   <para>
    On the control node, install &warewulf;:
   </para>
<screen>&prompt.user;sudo zypper install warewulf4</screen>
  </step>
  <step>
   <para>
    &warewulf; creates a basic configuration for the control node in the file
    <filename>/etc/warewulf/warewulf.conf</filename>. Check this file to make sure
    the networking details are correct, or update the details if required.
   </para>
  </step>
  <step>
   <para>
    Start and enable the &warewulf; service:
   </para>
<screen>&prompt.user;sudo systemctl enable --now warewulfd</screen>
  </step>
  <step>
   <para>
    If DHCP is not already in use on this node, add the interface on which
    the cluster network is running to <option>DHCP_INTERFACE</option> in the
    file <filename>/etc/sysconfig/dhcpd</filename>.
   </para>
  </step>
  <step>
   <para>
    Configure the services required by &warewulf;:
   </para>
<screen>&prompt.user;sudo wwctl configure --all</screen>
   <para>
    This command performs the following tasks:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Configures DHCP and enables the DHCP service.
     </para>
    </listitem>
    <listitem>
     <para>
      Updates the <filename>/etc/hosts</filename> file.
     </para>
    </listitem>
    <listitem>
     <para>
      Configures an NFS server on the control node and enables the NFS service.
     </para>
    </listitem>
    <listitem>
     <para>
      Creates host keys and user keys for passwordless SSH access to the nodes.
     </para>
    </listitem>
    <listitem>
     <para>
      Writes the required PXE files to the TFTP root directory and enables the TFTP service.
     </para>
    </listitem>
   </itemizedlist>
  </step>
  <step>
   <para>
    Import a compute node container from the &suse; registry:
   </para>
<screen>&prompt.user;sudo wwctl container import \
docker://registry.suse.com/suse/containers/<remark>TBD</remark> \
<remark>TBD</remark> --setdefault</screen>
   <para>
    The <option>--setdefault</option> argument sets this as the default container
    in the <literal>default</literal> node profile.
   </para>
  </step>
  <step>
   <para>
    Configure the networking details for the <literal>default</literal> node profile:
   </para>
<screen>&prompt.user;sudo wwctl profile set -y default --netname default \
--netmask &subnetmask; --gateway &subnetI;.1</screen>
   <para>
    To see the details of this profile, run the following command:
   </para>
<screen>&prompt.user;sudo wwctl profile list -a</screen>
  </step>
  <step>
   <para>
    Add compute nodes to &warewulf;. For example, to add ten discoverable nodes
    with preconfigured IP addresses, run the following command:
   </para>
<screen>&prompt.user;sudo wwctl node add n[01-10] \ <co xml:id="co-warewulf-deploy-node-name"/>
--netdev eth0 -I &subnetI;.11 \ <co xml:id="co-warewulf-deploy-node-network"/>
--discoverable=true <co xml:id="co-warewulf-deploy-node-discover"/></screen>
   <calloutlist>
    <callout arearefs="co-warewulf-deploy-node-name">
     <para>
      One or more node names. Node names must be unique. If you have node groups
      or multiple clusters, add descriptors to the node names, for example
      <literal>n01.cluster01</literal>.
     </para>
    </callout>
    <callout arearefs="co-warewulf-deploy-node-network">
     <para>
      The IP address for the first node. Subsequent nodes will be given incremental
      IP addresses.
     </para>
     <para>
      <remark>Should this address be inside or outside the DHCP range? In the
       internal doc it's inside the range but in the upstream doc it's outside the range.</remark>
     </para>
    </callout>
    <callout arearefs="co-warewulf-deploy-node-discover">
     <para>
      Allows &warewulf; to assign a MAC address to the nodes when they boot for
      the first time.
     </para>
    </callout>
   </calloutlist>
   <para>
    To view the settings for these nodes, run the following command:
   </para>
<screen>&prompt.user;sudo wwctl node list -a n[01-10]</screen>
  </step>
  <step>
   <para>
    Build the default system and runtime overlays for each node:
   </para>
<screen>&prompt.user;sudo wwctl overlay build</screen>
   <para>
    <remark>Do we need to do this, or is it automatic and you only need to run
     the command if you edit any overlays?</remark>
   </para>
   <para>
    <remark>Are there any HPC-specific things that we should direct people to
     add to an overlay/create an overlay for?</remark>
   </para>
  </step>
  <step>
   <para>
    Boot the compute nodes with PXE. &warewulf; provides all of the required information.
   </para>
  </step>
 </procedure>
 <itemizedlist>
  <title>For more information</title>
  <listitem>
   <para>
    &warewulf;: <link xlink:href="https://warewulf.org/docs/development/index.html"/>
   </para>
  </listitem>
  <listitem>
   <para>
    Node profiles: <link xlink:href="https://warewulf.org/docs/development/contents/profiles.html"/>
   </para>
  </listitem>
  <listitem>
   <para>
    &warewulf; overlays: <link xlink:href="https://warewulf.org/docs/development/contents/overlays.html"/>
   </para>
  </listitem>
  <listitem>
   <para>
    The node provisioning process: <link xlink:href="https://warewulf.org/docs/development/contents/provisioning.html"/>
   </para>
  </listitem>
 </itemizedlist>
</sect1>
